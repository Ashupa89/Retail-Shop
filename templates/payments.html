{% extends "base.html" %}
{% block content %}
<h2>Payments / Due Management</h2>

<table class="table table-striped table-hover">
    <thead>
    <tr>
        <th>Invoice No</th>
        <th>Customer</th>
        <th>Total (₹)</th>
        <th>Paid (₹)</th>
        <th>Due (₹)</th>
        <th>Last Payment Date</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    {% for sale in sales %}
    {% set paid_amount = sale.paid_amount %}
    {% set due_amount = sale.total - paid_amount %}
    <tr class="{% if sale.total - sale.paid_amount > 0 %}table-warning{% endif %}">
        <td>{{ sale.invoice_no }}</td>
        <td>{{ sale.customer_name }}</td>
        <td>{{ '%.2f'|format(sale.total) }}</td>
        <td>{{ '%.2f'|format(sale.paid_amount) }}</td>
        <td>{{ '%.2f'|format(sale.total - sale.paid_amount) }}</td>
        <td>
            {% set last_payment = sale.payments.order_by(Payment.payment_date.desc()).first() %}
            {% if last_payment %}
            {{ last_payment.payment_date.strftime('%d-%m-%Y') }}
            {% else %}
            N/A
            {% endif %}
        </td>
        <td>
            {% if sale.total - sale.paid_amount > 0 %}
            <button class="btn btn-sm btn-success add-payment-btn"
                    data-sale-id="{{ sale.id }}"
                    data-due="{{ sale.total - sale.paid_amount }}">
                Pay Due
            </button>
            {% else %}
            Paid
            {% endif %}
        </td>
    </tr>

    {% endfor %}
    </tbody>
</table>
<script>
    document.querySelectorAll('.add-payment-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
            const saleId = btn.dataset.saleId;
            const amount = parseFloat(btn.dataset.due);

            if (!amount || amount <= 0) return;

            const resp = await fetch(`/add-payment/${saleId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ amount })
            });

            let data;
            try {
                data = await resp.json();
            } catch (err) {
                console.error("Failed to parse JSON:", err);
                alert("Server returned invalid response.");
                return;
            }

            if (resp.ok) {
                btn.innerText = 'Paid';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-secondary');
                location.reload();
            } else {
                alert(data.error || 'Payment failed');
            }

        });
    });
</script>
{% endblock %}
